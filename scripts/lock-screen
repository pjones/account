#!/usr/bin/env bash

################################################################################
set -e
set -u

################################################################################
usage() {
  echo "Usage: $(basename "$0") default-image background-color"
}

################################################################################
if [ $# -ne 2 ]; then
  ussage
  exit 1
fi

default_lock_image=$1
background_color=$2

################################################################################
disable_dpms() {
  xset dpms 0 0 0
}
trap disable_dpms HUP INT TERM

################################################################################
resize() {
  local image=$1
  local image_png="${TMPDIR:-/tmp}/${USER}-lock.png"
  local width

  width=$(xrandr | grep 'connected primary' | cut -d' ' -f4 | cut -dx -f1)
  convert -resize "$width" "$image" "$image_png"

  echo "$image_png"
}

################################################################################
# Set delay before turning monitor off:
xset +dpms dpms 300 600 900

# Find an image to use:
file=$(random-file -i \
  -d ~/documents/pictures/backgrounds/lock-screen \
  -D "$default_lock_image")

# Try to resize the image to match the screen:
image=$(resize "$file" || echo "$file")

# Lock it!
i3lock \
  --nofork \
  --tiling \
  --image="$image" \
  --color="$background_color" \
  --ignore-empty-password \
  --show-failed-attempts

disable_dpms
